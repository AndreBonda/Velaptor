name: Build & Test (Development)

env:
  PROJECT_NAME: Velaptor

on:
  workflow_dispatch:
  pull_request:
    types: [ synchronize ]
    branches: [ develop, feature/move-to-github ]

jobs:
  Build_Project:
    name: Build Project
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x

    - name: Restore Dependencies
      run: dotnet restore "${{ github.workspace }}\${{ env.PROJECT_NAME }}\${{ env.PROJECT_NAME }}.csproj"

    - name: Build
      run: dotnet build "${{ github.workspace }}/${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj" --no-restore
  
  Run_Unit_Tests:
    name: Run Unit Tests
    needs: Build_Project
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup .NET 5.0.x
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 5.0.x
      
      - name: Restore Dependencies
        run: dotnet restore
      
      - name: Execute Unit Tests
        run: dotnet test "${{ github.workspace }}/Testing/${{ env.PROJECT_NAME }}Tests/${{ env.PROJECT_NAME }}Tests.csproj" -c Debug --collect:"XPlat Code Coverage"

      - name: Publish Code Coverage Results
        uses: codecov/codecov-action@v1.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ${{ github.workspace }}/Testing/${{ env.PROJECT_NAME }}Tests/TestResults/**/coverage.cobertura.xml

  Publish_Build_Artifacts:
    name: Publish Build Artifacts
    needs: Build_Project
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x

    - name: Restore Dependencies
      run: dotnet restore "${{ github.workspace }}\${{ env.PROJECT_NAME }}\${{ env.PROJECT_NAME }}.csproj"

    - name: Build
      run: dotnet build "${{ github.workspace }}/${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj" --no-restore

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v2.2.3
      with:
        name: Velaptor
        path: ${{ github.workspace }}/${{ env.PROJECT_NAME }}/bin/Debug/net5.0
        error: There was an issue uploading the build artifact
